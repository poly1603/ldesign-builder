# Builder è°ƒè¯•æ—¥å¿—è¯´æ˜

## æ¦‚è¿°

ä¸ºäº†å¸®åŠ©è¯Šæ–­æ„å»ºå¡ä½çš„é—®é¢˜ï¼Œæˆ‘ä»¬åœ¨ `@ldesign/builder` çš„å…³é”®æ­¥éª¤æ·»åŠ äº†è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—ã€‚

## ä½¿ç”¨æ–¹æ³•

### å¯ç”¨è°ƒè¯•æ¨¡å¼

```bash
# ä½¿ç”¨ --debug å‚æ•°
pnpm build --debug

# æˆ–è®¾ç½®æ—¥å¿—çº§åˆ«
pnpm build --log-level debug
```

## æ—¥å¿—è¾“å‡ºè¯´æ˜

### 1. é…ç½®åŠ è½½é˜¶æ®µ

```
ğŸ“„ åŠ è½½æŒ‡å®šé…ç½®æ–‡ä»¶: .ldesign/builder.config.ts
ğŸ“„ æ‰¾åˆ°é…ç½®æ–‡ä»¶: .ldesign/builder.config.ts
âš ï¸  æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤é…ç½®
```

**ä½œç”¨**: ç¡®è®¤é…ç½®æ–‡ä»¶æ˜¯å¦è¢«æ­£ç¡®æ‰¾åˆ°å’ŒåŠ è½½

### 2. é…ç½®è½¬æ¢é˜¶æ®µ

```
ğŸ”§ å¼€å§‹è½¬æ¢é…ç½®...
  è·å–åŸºç¡€æ’ä»¶...
  åŸºç¡€æ’ä»¶æ•°é‡: 4
  è§„èŒƒåŒ–è¾“å…¥é…ç½®...
  è¾“å…¥é…ç½®: {"index":"src/index.ts"}...
```

**ä½œç”¨**: è¿½è¸ªé…ç½®è½¬æ¢è¿‡ç¨‹ï¼Œç¡®è®¤è¾“å…¥é…ç½®æ˜¯å¦æ­£ç¡®

### 3. æ’ä»¶åŠ è½½é˜¶æ®µ

```
    åŠ è½½ @rollup/plugin-node-resolve...
    âœ… node-resolve åŠ è½½å®Œæˆ
    åŠ è½½ @rollup/plugin-commonjs...
    âœ… commonjs åŠ è½½å®Œæˆ
    åŠ è½½ @rollup/plugin-json...
    âœ… json åŠ è½½å®Œæˆ
    é…ç½® node-resolve æ’ä»¶...
    é…ç½® commonjs æ’ä»¶...
    é…ç½® json æ’ä»¶...
    æ£€æŸ¥ Babel æ’ä»¶...
    âŠ— Babel æ’ä»¶æœªå¯ç”¨
    âœ… åŸºç¡€æ’ä»¶åŠ è½½å®Œæˆï¼Œå…± 3 ä¸ª
```

**ä½œç”¨**: è¿½è¸ªæ¯ä¸ª Rollup æ’ä»¶çš„åŠ è½½è¿‡ç¨‹ï¼Œå¦‚æœå¡åœ¨æŸä¸ªæ’ä»¶åŠ è½½ï¼Œå¯ä»¥å¿«é€Ÿå®šä½

### 4. Rollup æ¨¡å—åŠ è½½

```
ğŸ”§ åŠ è½½ Rollup æ¨¡å—...
âœ… Rollup æ¨¡å—åŠ è½½å®Œæˆ
âš™ï¸  è½¬æ¢é…ç½®...
âœ… é…ç½®è½¬æ¢å®Œæˆ
```

**ä½œç”¨**: ç¡®è®¤ Rollup æ ¸å¿ƒæ¨¡å—æ˜¯å¦æˆåŠŸåŠ è½½

### 5. æ„å»ºæ‰§è¡Œé˜¶æ®µ

#### å¹¶è¡Œæ„å»ºæ¨¡å¼

```
ğŸ“¦ å¹¶è¡Œæ„å»º 3 ä¸ªé…ç½®...
  [1/3] å¼€å§‹ rollup.rollup()...
  [1/3] rollup.rollup() å®Œæˆ
  [1/3] å¼€å§‹ bundle.generate()...
  [1/3] bundle.generate() å®Œæˆ
  [1/3] å¼€å§‹ bundle.write()...
  [1/3] bundle.write() å®Œæˆ
  [2/3] å¼€å§‹ rollup.rollup()...
  ...
â³ ç­‰å¾…æ‰€æœ‰å¹¶è¡Œæ„å»ºå®Œæˆ...
âœ… æ‰€æœ‰å¹¶è¡Œæ„å»ºå®Œæˆ
```

#### å•é…ç½®æ„å»ºæ¨¡å¼

```
ğŸ“¦ å•é…ç½®æ„å»º...
  å¼€å§‹ rollup.rollup()...
  rollup.rollup() å®Œæˆ
  å¤„ç† 2 ä¸ªè¾“å‡ºé…ç½®...
  å¼€å§‹ bundle.generate() for es...
  bundle.generate() å®Œæˆï¼Œç”Ÿæˆ 10 ä¸ªæ–‡ä»¶
  å¼€å§‹ bundle.generate() for cjs...
  bundle.generate() å®Œæˆï¼Œç”Ÿæˆ 10 ä¸ªæ–‡ä»¶
  å¼€å§‹å†™å…¥æ–‡ä»¶...
  æ–‡ä»¶å†™å…¥å®Œæˆ
âœ… å•é…ç½®æ„å»ºå®Œæˆ
```

**ä½œç”¨**: è¿½è¸ªå®é™…çš„æ‰“åŒ…è¿‡ç¨‹ï¼Œå®šä½æ˜¯å“ªä¸ªæ­¥éª¤å¡ä½

### 6. æ„å»ºå®Œæˆ

```
â±ï¸  Rollup æ„å»ºæ€»è€—æ—¶: 2500ms
```

**ä½œç”¨**: æ˜¾ç¤ºæ€»æ„å»ºæ—¶é—´

## æ ¸å¿ƒæ„å»ºæ­¥éª¤

### LibraryBuilder é˜¶æ®µ

```
ğŸ§¹ æ¸…ç†è¾“å‡ºç›®å½•...
ğŸ”„ åˆ‡æ¢æ‰“åŒ…å™¨: rollup
ğŸ” æ£€æµ‹åº“ç±»å‹...
ğŸ“¦ åº“ç±»å‹: typescript
âš™ï¸  åº”ç”¨æ„å»ºç­–ç•¥...
ğŸ”¨ æ‰§è¡Œæ‰“åŒ…...
```

**ä½œç”¨**: è¿½è¸ª LibraryBuilder çš„å„ä¸ªé˜¶æ®µ

## å¸¸è§å¡ä½ä½ç½®åˆ†æ

### 1. å¡åœ¨é…ç½®åŠ è½½

**æ—¥å¿—åœåœ¨**:
```
ğŸ“„ åŠ è½½æŒ‡å®šé…ç½®æ–‡ä»¶: .ldesign/builder.config.ts
```

**å¯èƒ½åŸå› **:
- é…ç½®æ–‡ä»¶è¯­æ³•é”™è¯¯
- é…ç½®æ–‡ä»¶ä¸­æœ‰æ­»å¾ªç¯
- é…ç½®æ–‡ä»¶å¯¼å…¥äº†ä¸å­˜åœ¨çš„æ¨¡å—

**è§£å†³æ–¹æ³•**:
```bash
# æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
npx tsc --noEmit .ldesign/builder.config.ts
```

### 2. å¡åœ¨æ’ä»¶åŠ è½½

**æ—¥å¿—åœåœ¨**:
```
    åŠ è½½ @rollup/plugin-node-resolve...
```

**å¯èƒ½åŸå› **:
- æ’ä»¶åŒ…æœªå®‰è£…
- æ’ä»¶åŒ…ç‰ˆæœ¬ä¸å…¼å®¹
- node_modules æŸå

**è§£å†³æ–¹æ³•**:
```bash
# é‡æ–°å®‰è£…ä¾èµ–
rm -rf node_modules
pnpm install
```

### 3. å¡åœ¨ rollup.rollup()

**æ—¥å¿—åœåœ¨**:
```
  å¼€å§‹ rollup.rollup()...
```

**å¯èƒ½åŸå› **:
- å…¥å£æ–‡ä»¶ä¸å­˜åœ¨
- å…¥å£æ–‡ä»¶æœ‰è¯­æ³•é”™è¯¯
- å¾ªç¯ä¾èµ–
- TypeScript ç¼–è¯‘é”™è¯¯

**è§£å†³æ–¹æ³•**:
```bash
# æ£€æŸ¥ TypeScript é”™è¯¯
pnpm tsc --noEmit

# æ£€æŸ¥å¾ªç¯ä¾èµ–
npx madge --circular src/

# æ£€æŸ¥å…¥å£æ–‡ä»¶
ls -la src/index.ts
```

### 4. å¡åœ¨ bundle.generate()

**æ—¥å¿—åœåœ¨**:
```
  å¼€å§‹ bundle.generate() for es...
```

**å¯èƒ½åŸå› **:
- ä»£ç è½¬æ¢æ’ä»¶å¡ä½
- å¤§é‡æ–‡ä»¶éœ€è¦å¤„ç†
- å†…å­˜ä¸è¶³

**è§£å†³æ–¹æ³•**:
```bash
# å¢åŠ  Node.js å†…å­˜é™åˆ¶
NODE_OPTIONS=--max-old-space-size=4096 pnpm build --debug
```

### 5. å¡åœ¨ bundle.write()

**æ—¥å¿—åœåœ¨**:
```
  å¼€å§‹ bundle.write()...
```

**å¯èƒ½åŸå› **:
- ç£ç›˜ç©ºé—´ä¸è¶³
- æ–‡ä»¶æƒé™é—®é¢˜
- è¾“å‡ºç›®å½•è¢«å ç”¨

**è§£å†³æ–¹æ³•**:
```bash
# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h

# æ¸…ç†è¾“å‡ºç›®å½•
rm -rf es lib dist

# æ£€æŸ¥æ–‡ä»¶æƒé™
ls -la
```

## æ€§èƒ½åˆ†æ

### æŸ¥çœ‹å„é˜¶æ®µè€—æ—¶

æ„å»ºå®Œæˆåä¼šæ˜¾ç¤ºï¼š

```
â±ï¸  é˜¶æ®µè€—æ—¶:
  æ‰“åŒ…           â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     2.5s (66%) 
  ç±»å‹å£°æ˜         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘     1.1s (29%)
  åˆå§‹åŒ–          â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘    206ms (5%) 
  é…ç½®åŠ è½½         â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘      3ms (0%)
```

**åˆ†æ**:
- **æ‰“åŒ…æ—¶é—´è¿‡é•¿**: å¯èƒ½æ˜¯æ–‡ä»¶å¤ªå¤šæˆ–æœ‰å¤æ‚çš„è½¬æ¢
- **ç±»å‹å£°æ˜æ—¶é—´è¿‡é•¿**: TypeScript é¡¹ç›®è¾ƒå¤§
- **åˆå§‹åŒ–æ—¶é—´è¿‡é•¿**: æ’ä»¶åŠ è½½æ…¢æˆ–é…ç½®å¤æ‚

## è°ƒè¯•æŠ€å·§

### 1. é€æ­¥æ’æŸ¥

ä»æœ€åä¸€æ¡æ—¥å¿—å¼€å§‹ï¼Œå¾€å‰æŸ¥æ‰¾é—®é¢˜ï¼š

```bash
# å¦‚æœæœ€åä¸€æ¡æ˜¯
  [1/3] å¼€å§‹ rollup.rollup()...

# è¯´æ˜å¡åœ¨ç¬¬ä¸€ä¸ªé…ç½®çš„ rollup.rollup() æ­¥éª¤
# æ£€æŸ¥è¯¥é…ç½®çš„å…¥å£æ–‡ä»¶å’Œä¾èµ–
```

### 2. å¯¹æ¯”æ­£å¸¸é¡¹ç›®

```bash
# åœ¨æ­£å¸¸æ„å»ºçš„é¡¹ç›®ä¸­è¿è¡Œ
pnpm build --debug > normal.log 2>&1

# åœ¨æœ‰é—®é¢˜çš„é¡¹ç›®ä¸­è¿è¡Œ
pnpm build --debug > problem.log 2>&1

# å¯¹æ¯”æ—¥å¿—
diff normal.log problem.log
```

### 3. ä½¿ç”¨è¶…æ—¶æœºåˆ¶

æ„å»ºä¼šåœ¨ä»¥ä¸‹æ—¶é—´ç‚¹æç¤ºï¼š

- **30ç§’**: ç¬¬ä¸€æ¬¡æç¤º
- **1åˆ†é’Ÿ**: ç¬¬äºŒæ¬¡æç¤º + æ£€æŸ¥å»ºè®®
- **1åˆ†30ç§’**: ç¬¬ä¸‰æ¬¡æç¤º + debug å»ºè®®
- **5åˆ†é’Ÿ**: è¶…æ—¶å¹¶æ˜¾ç¤ºè¯¦ç»†é”™è¯¯

## ç¤ºä¾‹ï¼šå®Œæ•´çš„è°ƒè¯•æ—¥å¿—

```
ğŸ“¦ å…¥å£: src/index.ts | æ ¼å¼: esm+cjs+umd | æ¨¡å¼: production
ğŸ”¨ å¼€å§‹æ‰“åŒ…...

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸš€ @ldesign/builder
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  æ‰“åŒ…å™¨: rollup
  æ¨¡å¼:   production
  ç±»å‹:   unknown
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸ§¹ æ¸…ç†è¾“å‡ºç›®å½•...
ğŸ”„ åˆ‡æ¢æ‰“åŒ…å™¨: rollup
ğŸ” æ£€æµ‹åº“ç±»å‹...
ğŸ“¦ åº“ç±»å‹: typescript
âš™ï¸  åº”ç”¨æ„å»ºç­–ç•¥...
ğŸ”¨ æ‰§è¡Œæ‰“åŒ…...
ğŸ”§ åŠ è½½ Rollup æ¨¡å—...
âœ… Rollup æ¨¡å—åŠ è½½å®Œæˆ
âš™ï¸  è½¬æ¢é…ç½®...
ğŸ”§ å¼€å§‹è½¬æ¢é…ç½®...
  è·å–åŸºç¡€æ’ä»¶...
    åŠ è½½ @rollup/plugin-node-resolve...
    âœ… node-resolve åŠ è½½å®Œæˆ
    åŠ è½½ @rollup/plugin-commonjs...
    âœ… commonjs åŠ è½½å®Œæˆ
    åŠ è½½ @rollup/plugin-json...
    âœ… json åŠ è½½å®Œæˆ
    é…ç½® node-resolve æ’ä»¶...
    é…ç½® commonjs æ’ä»¶...
    é…ç½® json æ’ä»¶...
    æ£€æŸ¥ Babel æ’ä»¶...
    âŠ— Babel æ’ä»¶æœªå¯ç”¨
    âœ… åŸºç¡€æ’ä»¶åŠ è½½å®Œæˆï¼Œå…± 3 ä¸ª
  åŸºç¡€æ’ä»¶æ•°é‡: 3
  è§„èŒƒåŒ–è¾“å…¥é…ç½®...
  è¾“å…¥é…ç½®: {"index":"src/index.ts"}...
âœ… é…ç½®è½¬æ¢å®Œæˆ
ğŸ“¦ å¹¶è¡Œæ„å»º 3 ä¸ªé…ç½®...
  [1/3] å¼€å§‹ rollup.rollup()...
  [1/3] rollup.rollup() å®Œæˆ
  [1/3] å¼€å§‹ bundle.generate()...
  [1/3] bundle.generate() å®Œæˆ
  [1/3] å¼€å§‹ bundle.write()...
  [1/3] bundle.write() å®Œæˆ
  [2/3] å¼€å§‹ rollup.rollup()...
  [2/3] rollup.rollup() å®Œæˆ
  [2/3] å¼€å§‹ bundle.generate()...
  [2/3] bundle.generate() å®Œæˆ
  [2/3] å¼€å§‹ bundle.write()...
  [2/3] bundle.write() å®Œæˆ
  [3/3] å¼€å§‹ rollup.rollup()...
  [3/3] rollup.rollup() å®Œæˆ
  [3/3] å¼€å§‹ bundle.generate()...
  [3/3] bundle.generate() å®Œæˆ
  [3/3] å¼€å§‹ bundle.write()...
  [3/3] bundle.write() å®Œæˆ
â³ ç­‰å¾…æ‰€æœ‰å¹¶è¡Œæ„å»ºå®Œæˆ...
âœ… æ‰€æœ‰å¹¶è¡Œæ„å»ºå®Œæˆ
â±ï¸  Rollup æ„å»ºæ€»è€—æ—¶: 2500ms

âœ¨ æ„å»ºå®Œæˆ
```

## æŠ¥å‘Šé—®é¢˜

å¦‚æœé‡åˆ°æ„å»ºå¡ä½çš„é—®é¢˜ï¼Œè¯·æä¾›ï¼š

1. **å®Œæ•´çš„è°ƒè¯•æ—¥å¿—**
   ```bash
   pnpm build --debug > build-debug.log 2>&1
   ```

2. **é…ç½®æ–‡ä»¶**
   - `.ldesign/builder.config.ts`
   - `package.json`

3. **ç¯å¢ƒä¿¡æ¯**
   ```bash
   node --version
   pnpm --version
   ```

4. **æœ€åå‡ æ¡æ—¥å¿—**
   - æ—¥å¿—åœåœ¨å“ªä¸€æ­¥
   - ç­‰å¾…äº†å¤šé•¿æ—¶é—´

5. **é¡¹ç›®ä¿¡æ¯**
   - å…¥å£æ–‡ä»¶æ•°é‡
   - ä¾èµ–æ•°é‡
   - é¡¹ç›®å¤§å°
