# LDesign Builder - 使用指南

## 快速开始

### 安装

```bash
# 使用 pnpm
pnpm add @ldesign/builder

# 使用 npm
npm install @ldesign/builder

# 使用 yarn
yarn add @ldesign/builder
```

### 基础使用

```typescript
import { build } from '@ldesign/builder'

// 最简单的使用方式
await build({
  input: 'src/index.ts',
  outDir: 'dist',
})
```

## API 详细说明

### build() 函数

构建项目的主要函数。

```typescript
async function build(options: BuildOptions): Promise<BuildResult>
```

**参数说明**：

```typescript
interface BuildOptions {
  // 入口文件
  input: string | string[]
  
  // 输出目录
  outDir?: string
  
  // 输出格式
  formats?: OutputFormat[]
  
  // 构建模式
  mode?: 'development' | 'production'
  
  // 是否生成 sourcemap
  sourcemap?: boolean
  
  // 是否生成类型声明文件
  dts?: boolean
  
  // 外部依赖
  external?: string[] | ((id: string) => boolean)
  
  // 全局变量映射（用于 UMD 格式）
  globals?: Record<string, string>
  
  // 库名称（用于 UMD 格式）
  name?: string
  
  // 是否压缩代码
  minify?: boolean
  
  // 是否清理输出目录
  clean?: boolean
  
  // 自定义 Rollup 配置
  rollupOptions?: RollupOptions
}
```

**返回值**：

```typescript
interface BuildResult {
  success: boolean
  outputs: OutputInfo[]
  errors: BuildError[]
  warnings: string[]
  buildTime: number
}
```

### analyze() 函数

分析项目结构和依赖关系。

```typescript
async function analyze(root?: string): Promise<ProjectScanResult>
```

### watch() 函数

监听文件变化并自动重新构建。

```typescript
async function watch(options: BuildOptions): Promise<Watcher>
```

### defineConfig() 函数

提供类型安全的配置定义。

```typescript
function defineConfig(config: BuildOptions): BuildOptions
```

## 使用场景

### 1. Vue 组件库构建

```typescript
import { build, defineConfig } from '@ldesign/builder'

const config = defineConfig({
  input: 'src/index.ts',
  outDir: 'dist',
  formats: ['esm', 'cjs', 'umd'],
  dts: true,
  external: ['vue'],
  globals: {
    vue: 'Vue'
  },
  name: 'MyVueLibrary'
})

await build(config)
```

### 2. React 组件库构建

```typescript
import { build } from '@ldesign/builder'

await build({
  input: 'src/index.tsx',
  outDir: 'dist',
  formats: ['esm', 'cjs'],
  dts: true,
  external: ['react', 'react-dom'],
  globals: {
    react: 'React',
    'react-dom': 'ReactDOM'
  }
})
```

### 3. TypeScript 工具库构建

```typescript
import { build } from '@ldesign/builder'

await build({
  input: 'src/index.ts',
  outDir: 'dist',
  formats: ['esm', 'cjs'],
  dts: true,
  minify: true
})
```

### 4. 多入口构建

```typescript
import { build } from '@ldesign/builder'

await build({
  input: [
    'src/index.ts',
    'src/components/index.ts',
    'src/utils/index.ts'
  ],
  outDir: 'dist',
  formats: ['esm', 'cjs']
})
```

## 配置文件

### 创建配置文件

在项目根目录创建 `.ldesign/builder.config.ts`：

```typescript
import { defineConfig } from '@ldesign/builder'

export default defineConfig({
  input: 'src/index.ts',
  outDir: 'dist',
  formats: ['esm', 'cjs', 'umd'],
  dts: true,
  external: ['vue', 'react'],
  globals: {
    vue: 'Vue',
    react: 'React'
  }
})
```

### 条件配置

```typescript
import { defineConfig } from '@ldesign/builder'

export default defineConfig(({ mode }) => ({
  input: 'src/index.ts',
  outDir: 'dist',
  formats: mode === 'development' ? ['esm'] : ['esm', 'cjs', 'umd'],
  sourcemap: mode === 'development',
  minify: mode === 'production'
}))
```

## 高级用法

### 自定义插件配置

```typescript
import { build } from '@ldesign/builder'

await build({
  input: 'src/index.ts',
  outDir: 'dist',
  rollupOptions: {
    plugins: [
      // 自定义插件
    ]
  }
})
```

### 样式处理

```typescript
import { build } from '@ldesign/builder'

await build({
  input: 'src/index.ts',
  outDir: 'dist',
  // 自动检测并处理 CSS、Less、Sass 等样式文件
})
```

### 资源处理

```typescript
import { build } from '@ldesign/builder'

await build({
  input: 'src/index.ts',
  outDir: 'dist',
  // 自动处理图片、字体等静态资源
})
```

## 最佳实践

### 1. 项目结构

```
my-library/
├── src/
│   ├── components/
│   ├── utils/
│   └── index.ts
├── dist/           # 构建输出目录
├── package.json
├── tsconfig.json
└── ldesign.config.ts
```

### 2. package.json 配置

```json
{
  "name": "my-library",
  "main": "dist/cjs/index.js",
  "module": "dist/esm/index.js",
  "types": "dist/types/index.d.ts",
  "exports": {
    ".": {
      "import": "./dist/esm/index.js",
      "require": "./dist/cjs/index.js",
      "types": "./dist/types/index.d.ts"
    }
  },
  "files": [
    "dist"
  ]
}
```

### 3. TypeScript 配置

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "ESNext",
    "moduleResolution": "node",
    "declaration": true,
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

### 4. 构建脚本

```json
{
  "scripts": {
    "build": "node -e \"require('@ldesign/builder').build()\"",
    "dev": "node -e \"require('@ldesign/builder').watch()\"",
    "analyze": "node -e \"require('@ldesign/builder').analyze().then(console.log)\""
  }
}
```

## 故障排除

### 常见问题

1. **构建失败**：检查入口文件路径是否正确
2. **类型生成失败**：确保 tsconfig.json 配置正确
3. **插件加载失败**：检查相关依赖是否安装
4. **样式文件处理失败**：确保样式预处理器已安装

### 调试模式

```typescript
import { build } from '@ldesign/builder'

await build({
  input: 'src/index.ts',
  outDir: 'dist',
  mode: 'development',
  sourcemap: true
})
```
