# LDesign Builder - 架构设计

## 整体架构

LDesign Builder 采用模块化的架构设计，主要由以下几个核心模块组成：

```
┌─────────────────────────────────────────────────────────────┐
│                        用户 API 层                           │
├─────────────────────────────────────────────────────────────┤
│  build()  │  watch()  │  analyze()  │  init()  │ defineConfig() │
├─────────────────────────────────────────────────────────────┤
│                        核心业务层                           │
├─────────────┬─────────────┬─────────────┬─────────────────────┤
│ ProjectScanner │ PluginConfigurator │ RollupBuilder │ TypeGenerator │
├─────────────┴─────────────┴─────────────┴─────────────────────┤
│                        工具支撑层                           │
├─────────────────────────────────────────────────────────────┤
│  FileUtils  │  PathUtils  │  Logger  │  ConfigLoader  │ etc. │
└─────────────────────────────────────────────────────────────┘
```

## 核心模块设计

### 1. ProjectScanner（项目扫描器）

**职责**：分析项目结构，检测文件类型和依赖关系

**核心功能**：
- 扫描项目文件，识别文件类型
- 检测项目类型（Vue、React、TypeScript 等）
- 分析文件依赖关系，构建依赖图
- 识别入口文件

**设计特点**：
- 支持自定义扫描规则
- 可配置忽略模式
- 异步并发扫描，提高性能

### 2. PluginConfigurator（插件配置器）

**职责**：根据项目特征智能配置 Rollup 插件

**核心功能**：
- 分析项目需求，确定所需插件
- 自动配置插件参数
- 支持插件优先级和条件加载
- 提供插件扩展机制

**插件分类**：
- **基础插件**：node-resolve、commonjs、json
- **语言插件**：typescript、babel、esbuild
- **框架插件**：vue、vue-jsx、react
- **样式插件**：postcss、sass、less、stylus
- **优化插件**：terser、replace、strip

### 3. RollupBuilder（构建器）

**职责**：执行实际的构建过程

**核心功能**：
- 生成 Rollup 配置
- 执行多格式构建
- 处理构建错误和警告
- 支持监听模式

**输出格式**：
- **ESM**：保持目录结构，输出到 `dist/esm/`
- **CJS**：保持目录结构，输出到 `dist/cjs/`
- **UMD**：单文件输出，输出到 `dist/umd/`

### 4. TypeGenerator（类型生成器）

**职责**：生成 TypeScript 声明文件

**核心功能**：
- 分析 TypeScript 源码
- 生成类型声明文件
- 支持类型合并和优化
- 处理模块声明

## 数据流设计

```
用户输入 → ProjectScanner → PluginConfigurator → RollupBuilder → 输出文件
    ↓              ↓               ↓               ↓
  配置选项    → 项目分析结果  → 插件配置    → 构建结果
    ↓              ↓               ↓               ↓
TypeGenerator ← 扫描结果    ← 构建选项   ← 错误处理
    ↓
类型声明文件
```

## 插件系统架构

### 插件注册机制

```typescript
interface PluginFactory {
  (context: BuildContext): Promise<Plugin | null>
}

class PluginConfigurator {
  private pluginRegistry: Map<string, PluginFactory>
  
  registerPlugin(name: string, factory: PluginFactory): void
  createPlugin(name: string, context: BuildContext): Promise<Plugin | null>
}
```

### 插件配置流程

1. **需求分析**：分析项目文件，确定所需插件类型
2. **插件创建**：根据需求创建插件实例
3. **配置合并**：合并用户自定义配置
4. **优先级排序**：按照插件优先级排序
5. **条件过滤**：根据条件过滤插件

## 错误处理架构

### 分层错误处理

1. **API 层**：捕获和转换用户输入错误
2. **业务层**：处理业务逻辑错误
3. **工具层**：处理底层操作错误

### 错误类型定义

```typescript
interface BuildError {
  message: string
  code?: string
  file?: string
  line?: number
  column?: number
  stack?: string
}
```

## 配置系统架构

### 配置优先级

1. **用户配置**：用户显式传入的配置
2. **配置文件**：ldesign.config.ts/js
3. **自动检测**：基于项目分析的自动配置
4. **默认配置**：系统默认配置

### 配置合并策略

- **对象配置**：深度合并
- **数组配置**：替换合并
- **函数配置**：用户配置优先

## 性能优化设计

### 并发处理

- **文件扫描**：并发扫描多个文件
- **插件加载**：异步加载插件
- **构建过程**：利用 Rollup 的并行处理

### 缓存机制

- **文件缓存**：缓存文件分析结果
- **插件缓存**：缓存插件实例
- **配置缓存**：缓存配置解析结果

### 内存管理

- **流式处理**：大文件流式读取
- **及时释放**：及时释放不需要的对象
- **内存监控**：监控内存使用情况
